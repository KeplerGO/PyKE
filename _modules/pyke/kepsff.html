

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyke.kepsff &mdash; PyKE 3.0.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="PyKE 3.0.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PyKE
          

          
            
            <img src="../../_static/pyke-white.png" class="logo" />
          
          </a>

          
            
            
              <div class="version">
                3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/ipython_notebooks/whatsnew31.html">Whatâ€™s new in PyKE 3.1?</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/index.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tasks.html">PyKE tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../citing.html">Citing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/index.html">Photometry tutorials</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyKE</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pyke.kepsff</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyke.kepsff</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">.utils</span> <span class="k">import</span> <span class="n">PyKEArgumentHelpFormatter</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">kepmsg</span><span class="p">,</span> <span class="n">kepio</span><span class="p">,</span> <span class="n">kepkey</span><span class="p">,</span> <span class="n">kepplot</span><span class="p">,</span> <span class="n">kepfit</span><span class="p">,</span> <span class="n">kepfunc</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;kepsff&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="kepsff"><a class="viewcode-back" href="../../tasks/kepsff.html#pyke.kepsff.kepsff">[docs]</a><span class="k">def</span> <span class="nf">kepsff</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datacol</span><span class="o">=</span><span class="s1">&#39;DETSAP_FLUX&#39;</span><span class="p">,</span> <span class="n">cenmethod</span><span class="o">=</span><span class="s1">&#39;moments&#39;</span><span class="p">,</span>
           <span class="n">stepsize</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span> <span class="n">npoly_cxcy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_cxcy</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">npoly_ardx</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
           <span class="n">npoly_dsdt</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma_dsdt</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">npoly_arfl</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">sigma_arfl</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
           <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="s1">&#39;kepsff.log&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    kepsff -- remove motion-correlated noise from aperture light curve data</span>

<span class="sd">    The systematic noise within aperture-constructed K2 photometry is dominated</span>
<span class="sd">    by the effects of boresight roll under the force of solar pressure. Roll is</span>
<span class="sd">    minimized by orienting the spacecraft in pointing directions that minimize</span>
<span class="sd">    spacecraft structure asymmetry normal to the Sun-vector and compensated for</span>
<span class="sd">    over campaign durations by regular thruster firings, typically every 6</span>
<span class="sd">    hours. kepsff provides an open source python implementation of the</span>
<span class="sd">    photometric correction for K2 motion systematics provided by Vanderburg and</span>
<span class="sd">    Johnson (2014).The method will also work upon archived Kepler data and</span>
<span class="sd">    provides a relatively-simple and CPU-friendly alternative to cotrending</span>
<span class="sd">    against basis-vector derived ensemble photometry (``kepcotrend``),</span>
<span class="sd">    pixel-level principal component analysis (``keppca``), and PSF fitting</span>
<span class="sd">    (``kepprfphot``). As well, as computational speed, this method has the</span>
<span class="sd">    advantage of requiring no external data in order to perform corrections.</span>
<span class="sd">    All required data is extracted from individual Kepler light curves stored</span>
<span class="sd">    at the archive, or K2 light curves constructed from archived target pixel</span>
<span class="sd">    files using the kepextract task. In the example figure above, the 12th</span>
<span class="sd">    magnitude target, EPIC 202093219, has a median 6.5-hour standard deviation</span>
<span class="sd">    of 60 parts-per-million (according to the tool kepstddev. After motion</span>
<span class="sd">    correction using ``kepsff``, this quantity is reduced to 36 parts-per-million.</span>

<span class="sd">    The name ``kepsff`` is derived from &quot;Self-Flat-Fielding&quot; (SFF) and is</span>
<span class="sd">    propagated from the Vanderburg and Johnson (2014) paper. However the name</span>
<span class="sd">    is somewhat misleading because the effects corrected for in the K2 case are</span>
<span class="sd">    dominated by aperture losses and source crowding rather than flat-field</span>
<span class="sd">    variations. In essence, ``kepsff`` corrects motion-induced</span>
<span class="sd">    aperture-photometry artifacts after constructing a position-flux relation</span>
<span class="sd">    from a detrended (astrophysics-removed) version of the light curve. This</span>
<span class="sd">    tool will find most-employment upon K2 data, especially in the early</span>
<span class="sd">    mission phases when the data archives will contain calibrated target pixel</span>
<span class="sd">    files but no light curves. However, in line with the philosophy of the PyKE</span>
<span class="sd">    tools, ``kepsff`` provides the user with a degree of customization to meet</span>
<span class="sd">    the demands of a broad range of target types and science goals. The</span>
<span class="sd">    long-term goal is to provide Kepler and K2 users with a range of reduction</span>
<span class="sd">    options and this tool is part of that software kit. Also, in line with the</span>
<span class="sd">    PyKE philosophy, these algorithms, as coded, are not perfect. We recommend</span>
<span class="sd">    and welcome tinkering and further development by the community in order to</span>
<span class="sd">    make these tools better. This case is also precisely what the K2 community</span>
<span class="sd">    requires in the sense that the archive users, here Andrew Vanderburg and</span>
<span class="sd">    John Johnson, are seeking solutions to their own data reduction needs,</span>
<span class="sd">    becoming self-sufficient, and reporting their findings and methods to us</span>
<span class="sd">    all.</span>

<span class="sd">    Preparation work is required before kepsff can provide a good correction.</span>
<span class="sd">    First, a light curve needs to be extracted a from Target Pixel File</span>
<span class="sd">    (``kepextract``) using a user-customized pixel aperture defined within</span>
<span class="sd">    ``kepmask``. The resulting light curve also needs to be detrended, i.e. the</span>
<span class="sd">    astrophysics needs to be removed as much as possible (kepflatten) in order</span>
<span class="sd">    for the correction to be as precise as possible. Note that the astrophysics</span>
<span class="sd">    is not removed permanently, but care has to be taken to prepare the data</span>
<span class="sd">    this way before confidence in the correction can be built for individual</span>
<span class="sd">    light curves on a case-by-case basis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nfile : str</span>
<span class="sd">        The name of an input light curve FITS file. This file needs to contain</span>
<span class="sd">        a minimum set of information: Mid-exposure times, cadence numbers,</span>
<span class="sd">        simple-aperture flux, moment-derived and/or PSF-derived target</span>
<span class="sd">        centroids, quality flags and Kepler standard keywords. All of these</span>
<span class="sd">        properties are provided in archived light curves from the Kepler</span>
<span class="sd">        mission, but need to be calculated for the K2 mission. The PyKE tool</span>
<span class="sd">        kepextract calculates all these properties and provides an input file</span>
<span class="sd">        suitable for ``kepsff``. In addition, the input file also requires a</span>
<span class="sd">        column of detrended data, where long-term astrophysics and</span>
<span class="sd">        orbit-related systematics have been removed. The PyKE tool kepflatten</span>
<span class="sd">        performs this pre-step, producing a FITS column of detrended data (at</span>
<span class="sd">        low-frequencies) called DETSAP_FLUX.</span>
<span class="sd">    outfile : str</span>
<span class="sd">        The name of the output light curve FITS file. This file has the same</span>
<span class="sd">        structure as the input file with three content changes. The aperture</span>
<span class="sd">        photometry, DETSAP_FLUX, and detrended photometry, DETSAP_FLUX are</span>
<span class="sd">        corrected for motion-correlated noise. The quality flag column,</span>
<span class="sd">        SAP_QUALITY, includes a new bit-flag of value 131072 that identifies</span>
<span class="sd">        exposures collected during on-board thruster firings, typically</span>
<span class="sd">        occurring on a 6-hr cadence.</span>
<span class="sd">    datacol : str</span>
<span class="sd">        The name of the FITS data column containing detrended flux data (i.e.</span>
<span class="sd">        low-frequency structure removed). If the input file is a product of</span>
<span class="sd">        kepflatten then this column is named DETSAP_FLUX.</span>
<span class="sd">    cenmethod : str</span>
<span class="sd">        kepsff requires target position data on the CCD detector in order to</span>
<span class="sd">        correlate spacecraft boresight motion with systematic signal within the</span>
<span class="sd">        flux time-series. The typical Kepler/K2 light curve files have</span>
<span class="sd">        place-holders for two different measures of source centroid:</span>

<span class="sd">        * ``moments`` -- center-of-light within the pixel aperture</span>
<span class="sd">          (alternatively known as the zeroth-moment of the flux distribution</span>
<span class="sd">          over the pixels). These two arrays, the X and Y centroid over time,</span>
<span class="sd">          are stored in FITS columns MOM_CENTR1 and MOM_CENTR2.</span>
<span class="sd">        * ``psf`` -- the PSF-fitting method, the X and Y locations of best-fit</span>
<span class="sd">          PSF models to the aperture pixels. These are rarely available within</span>
<span class="sd">          archived Kepler data but can be stored in PSF_CENTR1 and PSF_CENTR2.</span>
<span class="sd">          Both sets of centroids are provided in the output from kepextract,</span>
<span class="sd">          where the moments data is generally preferred over the PSF data which</span>
<span class="sd">          derives from the simplifying assumptions that sources are not</span>
<span class="sd">          confused and are well-characterized by symmetric Gaussian profiles.</span>
<span class="sd">    stepsize : float [days]</span>
<span class="sd">        Ultimately, kepsff will construct a time-series of flux-correction</span>
<span class="sd">        factors based upon a correlation curve between spacecraft boresight</span>
<span class="sd">        motion and aperture-flux variation. Perhaps due to differential</span>
<span class="sd">        velocity aberration, this calibration is not stable over time. The</span>
<span class="sd">        somewhat clunky solution to this in the current version of the tool is</span>
<span class="sd">        re-calibrate the correlation and apply the subsequent correction over a</span>
<span class="sd">        series of discrete time windows. stepsize identifies the length of</span>
<span class="sd">        these windows in units of days. Some trial and error is required to</span>
<span class="sd">        optimize light curve correction. Window sizes of 4-6 days often provide</span>
<span class="sd">        the optimal correction, but astrophysical structure on these timescales</span>
<span class="sd">        can lead the user to adopt longer or shorter step sizes in order to</span>
<span class="sd">        reduce the unwanted impact of astrophysics on the correction.</span>
<span class="sd">    npoly_cxcy : int</span>
<span class="sd">        There is a sequence of four polynomial fits required to characterize</span>
<span class="sd">        and filter the input data in order to produce a flux-motion correlation</span>
<span class="sd">        curve. The following sequence of fit parameters is therefore quite</span>
<span class="sd">        dis-orienting until some familiarity is gained with hands-on</span>
<span class="sd">        experience. The diagnostic plots, provided when plot=True provide</span>
<span class="sd">        significant help here with the four fits delivered in the four</span>
<span class="sd">        left-most panels (figure 1). The first fit is to the centroid</span>
<span class="sd">        coordinates selected by cenmethod. These data points are provided in</span>
<span class="sd">        the top-left panel of the figure and generally trace very-close to a</span>
<span class="sd">        linear path across the detector. Fine-point motion is dominated by roll</span>
<span class="sd">        around the boresight and therefore small-angle, near-linear behavior is</span>
<span class="sd">        unsurprising. The two black lines represent the eigenvectors of the</span>
<span class="sd">        covariance matrix of the centroids. These eigenvectors are used to</span>
<span class="sd">        rotate the centroid distribution so that the direction of motion (x&#39;)</span>
<span class="sd">        is aligned to the x-axis of the rotated system. The rotation</span>
<span class="sd">        functionality requires user-optimization in one aspect. Obvious</span>
<span class="sd">        outliers need to be removed from the sample before the eigenvectors are</span>
<span class="sd">        calculated. We achieve this iterative sigma-clipping. The user defines</span>
<span class="sd">        the order of a polynomial fit (1st order is recommended) and a</span>
<span class="sd">        threshold distance from the best fit where data points outside that</span>
<span class="sd">        threshold are removed before the remaining data are re-fit. Iterations</span>
<span class="sd">        continue until no additional data points are rejected. The rejection</span>
<span class="sd">        threshold is provided by the argument sigma_cxcy. Points lying below</span>
<span class="sd">        the rejection threshold are plotted as green symbols whereas data</span>
<span class="sd">        points rejected by this process will be plotted red. In the example</span>
<span class="sd">        above, no data points are rejected. The most likely cause of outliers</span>
<span class="sd">        is data obtained while the spacecraft is not guiding on reference</span>
<span class="sd">        stars. We predict such occasions to be rare during optimal operations,</span>
<span class="sd">        but such observations were common during the engineering tests,</span>
<span class="sd">        including the first half of campaign 0.</span>
<span class="sd">    sigma_cxcy : float [sigma]</span>
<span class="sd">        Threshold for rejecting centroid data. The threshold is the number of</span>
<span class="sd">        1-sigma standard deviation distances from the best-fit. Points further</span>
<span class="sd">        from the best-fit than the threshold provided will be considered</span>
<span class="sd">        unrepresentative of the flux-motion correlation that the tool is</span>
<span class="sd">        attempting to characterize. These points are not thrown away, they are</span>
<span class="sd">        corrected in the final calculation with the rest of the data, but they</span>
<span class="sd">        play no further part in the calibration of the correlation.</span>
<span class="sd">    npoly_ardx : int</span>
<span class="sd">        Step 2 (top-middle panel) is the determination of the relatively small</span>
<span class="sd">        deviation of centroid motion from linear. Here, in the rotated frame,</span>
<span class="sd">        we fit a high-order polynomial to the centroid data filtered and</span>
<span class="sd">        rotated in the first step. The green curve is the integrated path</span>
<span class="sd">        length along that curve (s) minus the linear term. The calculation is</span>
<span class="sd">        provided by equation 4 of Vanderburg and Johnson (2014). The red curve</span>
<span class="sd">        is a polynomial fit to the integral which subsequently allows us to</span>
<span class="sd">        cheaply calculate the absolute motion of the centroids relative to</span>
<span class="sd">        linear location along the dominant eigenvector in the unrotated frame.</span>
<span class="sd">        Producing a &#39;fit of a fit&#39; is somewhat inelegant and open source</span>
<span class="sd">        developers could be challenged here to add some additional</span>
<span class="sd">        mathematical rigor to this step. However this section of the</span>
<span class="sd">        calculation has, so far, not proved to be critical - the path length</span>
<span class="sd">        integral is very close to linear, so cleaning this calculation up is</span>
<span class="sd">        low-priority currently.</span>
<span class="sd">    npoly_dsdt : int</span>
<span class="sd">        The third step (lower-left panel) is a prescription to filter out</span>
<span class="sd">        exposures collected during thruster firings. Firing occur typically on</span>
<span class="sd">        a 6-hr cadence and occur when the spacecraft has rolled far enough to</span>
<span class="sd">        trigger a pointing adjustment. These data cannot be corrected using the</span>
<span class="sd">        current method. They are flagged here so that they do not bias the</span>
<span class="sd">        motion-flux correlation calculation and so that they can be documented</span>
<span class="sd">        within the quality flags of the output file. A low-order polynomial is</span>
<span class="sd">        fit to the time derivative along the path length (ds/dt) using 3-sigma</span>
<span class="sd">        iterative clipping. ``npoly_dsdt`` provides the user with flexibility</span>
<span class="sd">        to choose the polynomial order. In the plot, the best fit is shown as a</span>
<span class="sd">        red, solid line.</span>
<span class="sd">    sigma_dsdt : float [sigma]</span>
<span class="sd">        This is a threshold limit in units of 1-sigma standard deviation from</span>
<span class="sd">        the best-fit. Data points falling outside of the threshold are</span>
<span class="sd">        more-likely-than-not collected during thruster firings. These points</span>
<span class="sd">        are flagged in the SAP_QUALITY column of the output file with the bit</span>
<span class="sd">        131072 and is not employed to calibrate the flux-motion relation. The</span>
<span class="sd">        threshold curve is plot as a red, dashed line and rejected points are</span>
<span class="sd">        colored red.</span>
<span class="sd">    npoly_arfl : int</span>
<span class="sd">        The fourth panel (lower-middle) provides the subsequent target motion</span>
<span class="sd">        vs aperture flux distribution. The red line is polynomial fit, the</span>
<span class="sd">        order of which is chosen by the user here. Iterative</span>
<span class="sd">        :math:`\sigma`-clipping is again required - the many outliers below</span>
<span class="sd">        the best-fit are astrophysical in nature (binary star eclipses) and</span>
<span class="sd">        would bias the fit if they were unrecognized or simply allowed to.</span>
<span class="sd">        The user has flexibility to change the order and clipping threshold</span>
<span class="sd">        in order to provide the most robust fit and there is a degree of</span>
<span class="sd">        objectivity in this process. A low polynomial is generally adequate,</span>
<span class="sd">        this example employs a 3rd order function.</span>
<span class="sd">    sigma_arfl : float [sigma]</span>
<span class="sd">        This is the threshold limit in units of 1-sigma standard deviation from</span>
<span class="sd">        the best-fit polynomial to the motion-flux relation. Data points</span>
<span class="sd">        falling outside of the threshold are in effect rejected from the</span>
<span class="sd">        calibration. Such points potentially contain astrophysical signal that</span>
<span class="sd">        would both bias the calculation and damp the astrophysical signal</span>
<span class="sd">        within the data after the correction has been made. The best-fit red</span>
<span class="sd">        line provides the correction factors within the data window. For each</span>
<span class="sd">        point along the aperture-derived flux curve (upper-right), the position</span>
<span class="sd">        along the arc can be calculated and the multiplicative correction</span>
<span class="sd">        factor to the flux can determined directly from the best-fit</span>
<span class="sd">        motion-flux relation. The subsequent corrected light curve is provided</span>
<span class="sd">        lower-right on the same plotting scale as above. The red points are</span>
<span class="sd">        those flagged as potential thruster firing and their 6-hr cadence</span>
<span class="sd">        suggests these events have generally been flagged well.</span>
<span class="sd">    plot : bool</span>
<span class="sd">        If true, diagnostic plots identical to figure 1 above will be rendered</span>
<span class="sd">        and also saved as PNG files. There will be a different plot for every</span>
<span class="sd">        time window defined by the stepsize parameters. If the output FITS file</span>
<span class="sd">        is named filename.fits then each PNG file will be named</span>
<span class="sd">        filename_nn.png, where nn is a sequential number beginning with 1.</span>
<span class="sd">    overwrite : bool</span>
<span class="sd">        Overwrite the output FITS file? if **overwrite** is **False** and an</span>
<span class="sd">        existing file has the same name as outfile then the task will stop with</span>
<span class="sd">        an error.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">        Print informative messages and warnings to the shell and logfile?</span>
<span class="sd">    logfile : str</span>
<span class="sd">        Name of the logfile containing error and warning messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="si">{}</span><span class="s2">.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__all__</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># log the call</span>
    <span class="n">hashline</span> <span class="o">=</span> <span class="s1">&#39;--------------------------------------------------------------&#39;</span>
    <span class="n">kepmsg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span><span class="n">hashline</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">call</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;KEPSFF -- &#39;</span>
            <span class="o">+</span> <span class="s1">&#39; infile=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; outfile=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; datacol=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datacol</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; cenmethod=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cenmethod</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; stepsize=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stepsize</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; npoly_cxcy=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoly_cxcy</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; sigma_cxcy=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_cxcy</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; npoly_ardx=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoly_ardx</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; npoly_dsdt=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoly_dsdt</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; sigma_dsdt=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_dsdt</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; npoly_arfl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">npoly_arfl</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; sigma_arfl=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sigma_arfl</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; plot=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; overwrite=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">overwrite</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; verbose=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
            <span class="o">+</span> <span class="s1">&#39; logfile=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">logfile</span><span class="p">))</span>

    <span class="n">kepmsg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">call</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># start time</span>
    <span class="n">kepmsg</span><span class="o">.</span><span class="n">clock</span><span class="p">(</span><span class="s1">&#39;KEPSFF started at&#39;</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># overwrite output file</span>
    <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="n">kepio</span><span class="o">.</span><span class="n">overwrite</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kepio</span><span class="o">.</span><span class="n">fileexists</span><span class="p">(</span><span class="n">outfile</span><span class="p">):</span>
        <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ERROR -- KEPSFF: </span><span class="si">{}</span><span class="s1"> exists. Use overwrite=True&#39;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">))</span>
        <span class="n">kepmsg</span><span class="o">.</span><span class="n">err</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># open input file</span>
    <span class="n">instr</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s1">&#39;readonly&#39;</span><span class="p">)</span>
    <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bjdref</span><span class="p">,</span> <span class="n">cadence</span> <span class="o">=</span> <span class="n">kepio</span><span class="o">.</span><span class="n">timekeys</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span>
                                                    <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">work</span> <span class="o">=</span> <span class="n">instr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FILEVER&#39;</span><span class="p">]</span>
        <span class="n">cadenom</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">cadenom</span> <span class="o">=</span> <span class="n">cadence</span>
    <span class="c1"># fudge non-compliant FITS keywords with no values</span>
    <span class="n">instr</span> <span class="o">=</span> <span class="n">kepkey</span><span class="o">.</span><span class="n">emptykeys</span><span class="p">(</span><span class="n">instr</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># read table structure</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">kepio</span><span class="o">.</span><span class="n">readfitstab</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="c1"># determine sequence of windows in time</span>
    <span class="n">frametim</span> <span class="o">=</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;FRAMETIM&#39;</span><span class="p">]</span>
    <span class="n">num_frm</span> <span class="o">=</span> <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;NUM_FRM&#39;</span><span class="p">]</span>
    <span class="n">exptime</span> <span class="o">=</span> <span class="n">frametim</span> <span class="o">*</span> <span class="n">num_frm</span> <span class="o">/</span> <span class="mi">86400</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tstop</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">winedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tstop</span> <span class="o">&gt;</span> <span class="n">winedge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">stepsize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">winedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">winedge</span><span class="p">,</span> <span class="n">tstop</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">winedge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tstop</span>
    <span class="n">winedge</span> <span class="o">=</span> <span class="p">(</span><span class="n">winedge</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">)</span> <span class="o">/</span> <span class="n">exptime</span>
    <span class="n">winedge</span> <span class="o">=</span> <span class="n">winedge</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">winedge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">winedge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">winedge</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">winedge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">winedge</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">))</span>
    <span class="c1"># step through the time windows</span>
    <span class="k">for</span> <span class="n">iw</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">winedge</span><span class="p">))):</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">winedge</span><span class="p">[</span><span class="n">iw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">winedge</span><span class="p">[</span><span class="n">iw</span><span class="p">]</span>
        <span class="c1"># filter input data table</span>
        <span class="n">work1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;CADENCENO&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">datacol</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;MOM_CENTR1&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;MOM_CENTR2&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;PSF_CENTR1&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;PSF_CENTR2&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span>
                          <span class="n">table</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;SAP_QUALITY&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">]],</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">work1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">work1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">work2</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[(</span><span class="n">work1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">work1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e5</span><span class="p">)]</span>


        <span class="c1"># assign table columns</span>
        <span class="n">intime</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">bjdref</span>
        <span class="n">cadenceno</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indata</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">mom_centr1</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">mom_centr2</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">psf_centr1</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">psf_centr2</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sap_quality</span> <span class="o">=</span> <span class="n">work2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cenmethod</span> <span class="o">==</span> <span class="s1">&#39;moments&#39;</span><span class="p">:</span>
            <span class="n">centr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mom_centr1</span><span class="p">)</span>
            <span class="n">centr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mom_centr2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_centr1</span><span class="p">)</span>
            <span class="n">centr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">psf_centr2</span><span class="p">)</span>

        <span class="c1"># fit centroid data with low-order polynomial</span>
        <span class="n">cfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">csig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">functype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kepfunc</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npoly_cxcy</span><span class="p">))</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">npoly_cxcy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly_cxcy</span><span class="p">):</span>
                <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pinit</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">plotx</span><span class="p">,</span> <span class="n">ploty</span> <span class="o">=</span> \
                <span class="n">kepfit</span><span class="o">.</span><span class="n">lsqclip</span><span class="p">(</span><span class="n">functype</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">centr1</span><span class="p">,</span> <span class="n">centr2</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">sigma_cxcy</span><span class="p">,</span> <span class="n">sigma_cxcy</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)):</span>
                <span class="n">cfit</span> <span class="o">+=</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">centr1</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                <span class="n">csig</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING -- KEPSFF: could not fit centroid data with&#39;</span>
                       <span class="s1">&#39; polynomial. There are no data points within the&#39;</span>
                       <span class="s1">&#39; range of input rows </span><span class="si">{}</span><span class="s1"> - </span><span class="si">{}</span><span class="s1">. Either increase the&#39;</span>
                       <span class="s1">&#39; stepsize (with an appreciation of the effects on&#39;</span>
                       <span class="s1">&#39; light curve quality this will have!), or better yet&#39;</span>
                       <span class="s1">&#39; - cut the timeseries up to remove large gaps in the&#39;</span>
                       <span class="s1">&#39; input light curve using kepclip.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">))</span>
            <span class="n">kepmsg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">warnmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># reject outliers</span>
        <span class="n">time_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">centr1_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">centr2_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">flux_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">cad_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cfit</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">centr2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cfit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">sigma_cxcy</span> <span class="o">*</span> <span class="n">csig</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">time_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_good</span><span class="p">,</span> <span class="n">intime</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">centr1_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centr1_good</span><span class="p">,</span> <span class="n">centr1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">centr2_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">,</span> <span class="n">centr2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">flux_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_good</span><span class="p">,</span> <span class="n">indata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">cad_good</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cad_good</span><span class="p">,</span> <span class="n">cadenceno</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># covariance matrix for centroid time series</span>
        <span class="n">centr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">centr1_good</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr1_good</span><span class="p">),</span>
                                <span class="p">[</span><span class="n">centr2_good</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">)])</span>
        <span class="n">covar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">centr</span><span class="p">)</span>
        <span class="c1"># eigenvector eigenvalues of covariance matrix</span>
        <span class="p">[</span><span class="n">_</span><span class="p">,</span> <span class="n">evec</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">covar</span><span class="p">)</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="n">epar</span> <span class="o">=</span> <span class="n">evec</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">evec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ex</span>
        <span class="n">enor</span> <span class="o">=</span> <span class="n">evec</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">evec</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ex</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr1</span><span class="p">)</span>
        <span class="n">epar</span> <span class="o">=</span> <span class="n">epar</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">)</span>
        <span class="n">enor</span> <span class="o">=</span> <span class="n">enor</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">)</span>
        <span class="c1"># rotate centroid data</span>
        <span class="n">centr_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">centr</span><span class="p">)</span>
        <span class="c1"># fit polynomial to rotated centroids</span>
        <span class="n">rfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">rsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">functype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kepfunc</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npoly_ardx</span><span class="p">))</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])])</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">npoly_ardx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly_ardx</span><span class="p">):</span>
                <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pinit</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coeffs</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">plotx</span><span class="p">,</span> <span class="n">ploty</span> <span class="o">=</span> \
                <span class="n">kepfit</span><span class="o">.</span><span class="n">lsqclip</span><span class="p">(</span><span class="n">functype</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span>
                               <span class="n">centr_rot</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span>
                               <span class="n">verbose</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING -- KEPSFF: could not fit rotated centroid data&#39;</span>
                      <span class="s1">&#39; with polynomial&#39;</span><span class="p">)</span>
            <span class="n">kepmsg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">warnmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]),</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coeffs</span><span class="p">)):</span>
            <span class="n">ry</span> <span class="o">=</span> <span class="n">ry</span> <span class="o">+</span> <span class="n">coeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>

        <span class="c1"># calculate arclength of centroids</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)):</span>
            <span class="n">work3</span> <span class="o">=</span> <span class="p">((</span><span class="n">ry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ry</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">work3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># fit arclength as a function of strongest eigenvector</span>
        <span class="n">sfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">ssig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">centr2</span><span class="p">)))</span>
        <span class="n">functype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kepfunc</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npoly_ardx</span><span class="p">))</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">s</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">npoly_ardx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly_ardx</span><span class="p">):</span>
                <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pinit</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">acoeffs</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">plotx</span><span class="p">,</span> <span class="n">ploty</span> <span class="o">=</span> \
                <span class="n">kepfit</span><span class="o">.</span><span class="n">lsqclip</span><span class="p">(</span><span class="n">functype</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
                               <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING -- KEPSFF: could not fit arclength data&#39;</span>
                       <span class="s1">&#39; with polynomial&#39;</span><span class="p">)</span>
            <span class="n">kepmsg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">warnmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># correlate arclength with detrended flux</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">time_good</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cad_good</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flux_good</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acoeffs</span><span class="p">)):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">acoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># calculate time derivative of arclength s</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># fit polynomial to derivative and flag outliers (thruster firings)</span>
        <span class="n">dfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dx</span><span class="p">)))</span>
        <span class="n">dsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dx</span><span class="p">)))</span>
        <span class="n">functype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kepfunc</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npoly_dsdt</span><span class="p">))</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dx</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">npoly_dsdt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly_dsdt</span><span class="p">):</span>
                <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pinit</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dcoeffs</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">dsigma</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">dumx</span><span class="p">,</span> <span class="n">dumy</span> <span class="o">=</span> \
                <span class="n">kepfit</span><span class="o">.</span><span class="n">lsqclip</span><span class="p">(</span><span class="n">functype</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                               <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING -- KEPSFF: could not fit arclength derivative&#39;</span>
                       <span class="s1">&#39; with polynomial.&#39;</span><span class="p">)</span>
            <span class="n">kepmsg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">warnmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dcoeffs</span><span class="p">)):</span>
            <span class="n">dfit</span> <span class="o">=</span> <span class="n">dfit</span> <span class="o">+</span> <span class="n">dcoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">centr1_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">centr2_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">time_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">flux_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">dx_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">s_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">time_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">flux_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">dx_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">thr_cadence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dfit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">sigma_dsdt</span> <span class="o">*</span> <span class="n">dsigma</span>
                <span class="ow">and</span> <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dfit</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">sigma_dsdt</span> <span class="o">*</span> <span class="n">dsigma</span><span class="p">):</span>
                <span class="n">time_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_pnt</span><span class="p">,</span> <span class="n">time_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">flux_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_pnt</span><span class="p">,</span> <span class="n">flux_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">dx_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dx_pnt</span><span class="p">,</span> <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">s_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_pnt</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">centr1_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centr1_pnt</span><span class="p">,</span> <span class="n">centr1_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">centr2_pnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">centr2_pnt</span><span class="p">,</span> <span class="n">centr2_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_thr</span><span class="p">,</span> <span class="n">time_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">flux_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_thr</span><span class="p">,</span> <span class="n">flux_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">dx_thr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dx_thr</span><span class="p">,</span> <span class="n">dx</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">thr_cadence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cad_good</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># fit arclength-flux correlation</span>
        <span class="n">cfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_pnt</span><span class="p">)))</span>
        <span class="n">csig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">time_pnt</span><span class="p">)))</span>
        <span class="n">functype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">kepfunc</span><span class="p">,</span> <span class="s1">&#39;poly&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">npoly_arfl</span><span class="p">))</span>
        <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">flux_pnt</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">npoly_arfl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npoly_arfl</span><span class="p">):</span>
                <span class="n">pinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pinit</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ccoeffs</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">covar</span><span class="p">,</span> <span class="n">iiter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">plx</span><span class="p">,</span> <span class="n">ply</span> <span class="o">=</span> \
                <span class="n">kepfit</span><span class="o">.</span><span class="n">lsqclip</span><span class="p">(</span><span class="n">functype</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">s_pnt</span><span class="p">,</span> <span class="n">flux_pnt</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">sigma_arfl</span><span class="p">,</span> <span class="n">sigma_arfl</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;WARNING -- KEPSFF: could not fit arclength-flux&#39;</span>
                       <span class="s1">&#39; correlation with polynomial&#39;</span><span class="p">)</span>
            <span class="n">kepmsg</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">warnmsg</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># correction factors for unfiltered data</span>
        <span class="n">centr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">centr1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr1_good</span><span class="p">),</span>
                                <span class="p">[</span><span class="n">centr2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">)])</span>
        <span class="n">centr_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">centr</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="p">)))</span>
        <span class="n">cfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acoeffs</span><span class="p">)):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">acoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccoeffs</span><span class="p">)):</span>
            <span class="n">cfac</span> <span class="o">=</span> <span class="n">cfac</span> <span class="o">+</span> <span class="n">ccoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># apply correction to flux time-series</span>
        <span class="n">out_detsap</span> <span class="o">=</span> <span class="n">indata</span> <span class="o">/</span> <span class="n">cfac</span>
        <span class="c1"># split time-series data for plotting</span>
        <span class="n">tim_gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">flx_gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">tim_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">flx_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indata</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">intime</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">time_pnt</span><span class="p">:</span>
                <span class="n">tim_gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tim_gd</span><span class="p">,</span> <span class="n">intime</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">flx_gd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flx_gd</span><span class="p">,</span> <span class="n">out_detsap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tim_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tim_bd</span><span class="p">,</span> <span class="n">intime</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">flx_bd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flx_bd</span><span class="p">,</span> <span class="n">out_detsap</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="c1"># plot style and size</span>
            <span class="c1">#kepplot.define(16, 14, logfile, verbose)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="c1"># plot x-centroid vs y-centroid</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.57</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">])</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">centr1</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">centr2</span><span class="p">)</span>
            <span class="n">pxmin</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">pxmax</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">pymin</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">pymax</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">pxr</span> <span class="o">=</span> <span class="n">pxmax</span> <span class="o">-</span> <span class="n">pxmin</span>
            <span class="n">pyr</span> <span class="o">=</span> <span class="n">pymax</span> <span class="o">-</span> <span class="n">pymin</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">pxr</span> <span class="o">&gt;</span> <span class="n">pyr</span><span class="p">:</span>
                <span class="n">dely</span> <span class="o">=</span> <span class="p">(</span><span class="n">pxr</span> <span class="o">-</span> <span class="n">pyr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">pxmin</span> <span class="o">-</span> <span class="n">pxr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pxmax</span> <span class="o">+</span> <span class="n">pxr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">pymin</span> <span class="o">-</span> <span class="n">dely</span> <span class="o">-</span> <span class="n">pyr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pymax</span> <span class="o">+</span> <span class="n">dely</span> <span class="o">+</span> <span class="n">pyr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delx</span> <span class="o">=</span> <span class="p">(</span><span class="n">pyr</span> <span class="o">-</span> <span class="n">pxr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">pymin</span> <span class="o">-</span> <span class="n">pyr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pymax</span> <span class="o">+</span> <span class="n">pyr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">pxmin</span> <span class="o">-</span> <span class="n">delx</span> <span class="o">-</span> <span class="n">pxr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">,</span> <span class="n">pxmax</span> <span class="o">+</span> <span class="n">delx</span> <span class="o">+</span> <span class="n">pxr</span> <span class="o">*</span> <span class="n">pad</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#980000&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">centr1_good</span><span class="p">,</span> <span class="n">centr2_good</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#009900&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                     <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span><span class="n">epar</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span><span class="n">enor</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="s1">&#39;CCD Column&#39;</span><span class="p">,</span> <span class="s1">&#39;CCD Row&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

            <span class="c1"># plot arclength fits vs drift along strongest eigenvector</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.57</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">])</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">rx</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="n">rx</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleany</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">RangeOfPlot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#009900&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">plotx</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">ploty</span> <span class="o">-</span> <span class="n">plotx</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleany</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; e\S+&#39;</span><span class="p">,</span> <span class="s1">&#39; pixels)&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">)</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39; s\S+&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">)</span>
            <span class="n">ylab</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span> <span class="s1">&#39;s $-$ x</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="s1">&#39;Linear Drift [x</span><span class="se">\&#39;</span><span class="s1">] (pixels)&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

            <span class="c1"># plot time derivative of arclength s</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.04</span><span class="p">,</span><span class="mf">0.08</span><span class="p">,</span><span class="mf">0.16</span><span class="p">,</span><span class="mf">0.41</span><span class="p">])</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">time_pnt</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dx_pnt</span><span class="p">)</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">logfile</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">RangeOfPlot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#009900&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">time_thr</span><span class="p">)</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dx_thr</span><span class="p">)</span>
                <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#980000&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dfit</span><span class="p">)</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dfit</span> <span class="o">+</span> <span class="n">sigma_dsdt</span> <span class="o">*</span> <span class="n">dsigma</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">dfit</span><span class="o">-</span><span class="n">sigma_dsdt</span><span class="o">*</span><span class="n">dsigma</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="s1">&#39;ds/dt (pixels day$^{-1}$)&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="c1"># plot relation of arclength vs detrended flux</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.24</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.41</span><span class="p">])</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">s_pnt</span><span class="p">)</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flux_pnt</span><span class="p">)</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleany</span><span class="p">(</span><span class="n">py</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">RangeOfPlot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#009900&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plx</span><span class="p">,</span> <span class="n">ply</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_ticks</span><span class="p">():</span>
                <span class="n">tick</span><span class="o">.</span><span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="s1">&#39;Arclength [s] (pixels)&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

            <span class="c1"># plot aperture photometry</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.44</span><span class="p">,</span> <span class="mf">0.53</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">])</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">intime</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleany</span><span class="p">(</span><span class="n">indata</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">RangeOfPlot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">plot1d</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">cadence</span><span class="p">,</span> <span class="s1">&#39;#0000ff&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="n">ylab</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">(),</span><span class="n">xticklabels</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span><span class="s1">&#39;Aperture Flux&#39;</span><span class="p">,</span><span class="n">ylab</span><span class="p">),</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">location</span><span class="p">([</span><span class="mf">0.44</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">])</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">RangeOfPlot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">tim_gd</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">py</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleany</span><span class="p">(</span><span class="n">flx_gd</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">plot1d</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">cadence</span><span class="p">,</span> <span class="s1">&#39;#0000ff&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;#ffff00&#39;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">px</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">kepplot</span><span class="o">.</span><span class="n">cleanx</span><span class="p">(</span><span class="n">tim_bd</span><span class="p">,</span><span class="n">logfile</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">flx_bd</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#980000&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="n">ls</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">kepplot</span><span class="o">.</span><span class="n">labels</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span> <span class="s1">&#39;Corrected Flux&#39;</span><span class="p">,</span> <span class="n">ylab</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="c1"># render plot</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">,</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iw</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">outfile</span><span class="p">))</span>

        <span class="c1"># correct fluxes within the output file</span>
        <span class="n">intime</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="n">bjdref</span>
        <span class="n">cadenceno</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">indata</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">5</span><span class="p">]</span>
        <span class="n">mom_centr1</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">mom_centr2</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">psf_centr1</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">psf_centr2</span> <span class="o">=</span> <span class="n">work1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">centr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mom_centr1</span><span class="p">)</span>
        <span class="n">centr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mom_centr2</span><span class="p">)</span>
        <span class="n">centr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([[</span><span class="n">centr1</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr1_good</span><span class="p">),</span>
                               <span class="p">[</span><span class="n">centr2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">centr2_good</span><span class="p">)])</span>
        <span class="n">centr_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">evec</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">centr</span><span class="p">)</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indata</span><span class="p">)</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">centr_rot</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="p">)))</span>
        <span class="n">cfac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">zz</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acoeffs</span><span class="p">)):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">+</span> <span class="n">acoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">zz</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ccoeffs</span><span class="p">)):</span>
            <span class="n">cfac</span> <span class="o">=</span> <span class="n">cfac</span> <span class="o">+</span> <span class="n">ccoeffs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">out_detsap</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">/</span> <span class="n">cfac</span>
        <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;SAP_FLUX&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">cfac</span>
        <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;PDCSAP_FLUX&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">cfac</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;DETSAP_FLUX&#39;</span><span class="p">)[</span><span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">]</span> <span class="o">/=</span> <span class="n">cfac</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># add quality flag to output file for thruster firings</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intime</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cadenceno</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">thr_cadence</span><span class="p">:</span>
                <span class="n">instr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s1">&#39;SAP_QUALITY&#39;</span><span class="p">)[</span><span class="n">t1</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">131072</span>
    <span class="c1"># write output file</span>
    <span class="n">kepmsg</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="s2">&quot;Writing output file </span><span class="si">{}</span><span class="s2">...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">outfile</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="c1"># close input file</span>
    <span class="n">instr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># end time</span>
    <span class="n">kepmsg</span><span class="o">.</span><span class="n">clock</span><span class="p">(</span><span class="s1">&#39;KEPSFF completed at&#39;</span><span class="p">,</span> <span class="n">logfile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">kepsff_main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">argparse</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Correct aperture photmetry using target motion&#39;</span><span class="p">,</span>
             <span class="n">formatter_class</span><span class="o">=</span><span class="n">PyKEArgumentHelpFormatter</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;infile&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of input FITS file&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--outfile&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Name of FITS file to output.&#39;</span>
                              <span class="s1">&#39; If None, outfile is infile-kepsff.&#39;</span><span class="p">),</span>
                        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--datacol&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;DETSAP_FLUX&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of data column&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cenmethod&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;moments&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Centroid method&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
                        <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;moments&#39;</span><span class="p">,</span><span class="s1">&#39;psf&#39;</span><span class="p">])</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--stepsize&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Stepsize over which to calibrate data [days]&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--npoly_cxcy&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Order of ploynomial fit to target centroids&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sigma_cxcy&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Sigma-clipping threshold for fit to target&#39;</span>
                              <span class="s1">&#39; centroids [sigma]&#39;</span><span class="p">),</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--npoly_ardx&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Order of ploynomial fit for thruster firing&#39;</span>
                              <span class="s1">&#39; detection&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--npoly_dsdt&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Order of ploynomial fit for thruster firing&#39;</span>
                              <span class="s1">&#39; detection&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sigma_dsdt&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Sigma-clipping threshold for thruster firing&#39;</span>
                              <span class="s1">&#39; detection [sigma]&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--npoly_arfl&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Order of ploynomial for arclength-flux&#39;</span>
                              <span class="s1">&#39; calibration&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sigma_arfl&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Sigma-clipping threshold for arclength-flux&#39;</span>
                              <span class="s1">&#39; calibration [sigma]&#39;</span><span class="p">),</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Save hardcopies of the plots?&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--overwrite&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Overwrite output file?&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Write to a log file?&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--logfile&#39;</span><span class="p">,</span> <span class="s1">&#39;-l&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of ascii log file&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;kepsff.log&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;logfile&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">kepsff</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">infile</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">outfile</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">datacol</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">cenmethod</span><span class="p">,</span>
           <span class="n">args</span><span class="o">.</span><span class="n">stepsize</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">npoly_cxcy</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sigma_cxcy</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">npoly_ardx</span><span class="p">,</span>
           <span class="n">args</span><span class="o">.</span><span class="n">npoly_dsdt</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sigma_dsdt</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">npoly_arfl</span><span class="p">,</span>
           <span class="n">args</span><span class="o">.</span><span class="n">sigma_arfl</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">overwrite</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span>
           <span class="n">args</span><span class="o">.</span><span class="n">logfile</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright PyKE Developers and Contributors.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'3.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>